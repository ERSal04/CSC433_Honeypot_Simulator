import hashlib
import os

class MalwareDetector:
    """
    Analyzes files downloaded or uploaded by attackers.
    Calculates hashes and checks file headers.
    """
    
    def scan_file(self, file_path):
        """
        Reads a file from disk, calculates its hash, and identifies its type.
        """
        if not os.path.exists(file_path):
            return {"status": "file_not_found"}

        try:
            with open(file_path, "rb") as f:
                content = f.read()

            file_hash = hashlib.sha256(content).hexdigest()
            file_type = self._detect_magic_bytes(content)
            
            # In a real system, you would check this hash against VirusTotal here.
            is_known_malware = self._check_known_signatures(file_hash)

            return {
                "sha256": file_hash,
                "file_type": file_type,
                "is_malware": is_known_malware or (file_type in ["ELF", "EXE"]),
                "size": len(content)
            }
        except Exception as e:
            return {"status": "error", "details": str(e)}

    def _detect_magic_bytes(self, content):
        """Checks the first few bytes of the file to guess the format."""
        if content.startswith(b'\x7fELF'):
            return "ELF"  # Linux Executable
        elif content.startswith(b'MZ'):
            return "EXE"  # Windows Executable
        elif content.startswith(b'#!'):
            return "SCRIPT" # Shell script
        else:
            return "UNKNOWN"

    def _check_known_signatures(self, file_hash):
        """Simulated database of known bad hashes."""
        # Example hash of the 'Mirai' botnet
        known_bad = [
            "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855" 
        ]
        return file_hash in known_bad 